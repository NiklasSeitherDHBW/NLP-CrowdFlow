name: Test Jupyter Notebooks

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test-run-notebooks-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Miniconda
      uses: conda-incubator/setup-miniconda@v2
      with:
        auto-update-conda: true
        environment-file: environment.yml
        activate-environment: DHBW-NLP-CrowdFlow

    - name: Verify Installation
      shell: bash
      run: |
        eval "$(conda shell.bash hook)"
        conda activate DHBW-NLP-CrowdFlow
        python --version
        conda list

    - name: Run Jupyter Notebooks
      shell: bash
      run: |
        eval "$(conda shell.bash hook)"
        conda activate DHBW-NLP-CrowdFlow
        mkdir -p .github/workflows/output
        for notebook in $(find ./src -name "*.ipynb"); do
          echo "Running $notebook"
          jupyter nbconvert --to notebook --execute $notebook --output .github/workflows/output/$(basename ${notebook%.ipynb}_linux_executed.ipynb)
          echo ""
        done

    - name: Upload Executed Notebooks as Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: executed-notebooks-linux
        path: .github/workflows/output/*_linux_executed.ipynb

  test-run-notebooks-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Miniconda
      uses: conda-incubator/setup-miniconda@v2
      with:
        auto-update-conda: true
        environment-file: environment.yml
        activate-environment: DHBW-NLP-CrowdFlow

    - name: Verify Installation
      shell: cmd
      run: |
        CALL conda.bat activate DHBW-NLP-CrowdFlow
        python --version
        conda list

    - name: Run Jupyter Notebooks
      shell: cmd
      run: |
        mkdir .github\workflows\output
        FOR /R ./src %%G IN (*.ipynb) DO (
          ECHO Running %%G
          jupyter nbconvert --to notebook --execute %%G --output .github\workflows\output\%%~nG_windows_executed.ipynb
          ECHO.
        )

    - name: Upload Executed Notebooks as Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: executed-notebooks-windows
        path: .github\workflows\output\*_windows_executed.ipynb
